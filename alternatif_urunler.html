<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>ŞENTÜRK – Diğer Markalar Fiyat Listesi</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- SheetJS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <style>
    :root{
      --bg:#ececec;
      --paper:#ffffff;
      --paperBorder:#cfcfcf;
      --shadow: rgba(0,0,0,0.18);

      --text:#222;
      --muted:#6b7280;

      --btn:#111827;
      --btnText:#fff;
      --btn2:#f3f4f6;
      --btn2Text:#111827;

      --tableBorder:#dedede;
      --thead:#f2f2f2;

      --sectionHead:#111827;
      --sectionHeadText:#f9fafb;
      --rowAlt:#f7f7f7;
    }

    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family: system-ui,-apple-system,"Segoe UI",sans-serif;
      background: var(--bg);
      color: var(--text);
      padding: 18px;
    }

    .paper{
      max-width: 1100px;
      margin: 0 auto;
      background: var(--paper);
      border: 1px solid var(--paperBorder);
      box-shadow: 0 8px 24px var(--shadow);
      padding: 22px 26px 28px;
    }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:16px;
      margin-bottom: 10px;
    }

    .logoSide{
      display:flex;
      align-items:center;
      gap:10px;
      min-width: 220px;
    }
    .logoSide.right{
      justify-content:flex-end;
      text-align:right;
    }

    .logoSide img{
      height: 54px;
      width:auto;
      display:block;
      object-fit:contain;
    }

    .titleWrap{
      flex: 1;
      text-align:center;
      border-top: 2px solid #333;
      padding-top: 10px;
      margin: 0 10px;
    }

    .titleWrap h1{
      font-size: 18px;
      font-weight: 800;
      letter-spacing: 0.06em;
    }

    .titleWrap .sub{
      margin-top: 6px;
      font-size: 12px;
      color: var(--muted);
    }

    .controlsRow{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      margin-top: 14px;
      margin-bottom: 12px;
    }

    .controlsRow label{
      font-size: 12px;
      color: var(--muted);
      margin-right: 4px;
      white-space:nowrap;
    }

    input[type="file"]{
      font-size: 12px;
    }

    .search{
      padding: 7px 12px;
      border: 1px solid #cfcfcf;
      border-radius: 6px;
      min-width: 260px;
      font-size: 13px;
    }

    .btn{
      border: 1px solid #111827;
      border-radius: 6px;
      padding: 7px 12px;
      cursor:pointer;
      font-size: 13px;
      line-height: 1;
      white-space:nowrap;
    }

    .btn-dark{
      background: var(--btn);
      color: var(--btnText);
    }
    .btn-light{
      background: var(--btn2);
      color: var(--btn2Text);
      border-color: #cfcfcf;
    }

    .hint{
      font-size: 12px;
      color: var(--muted);
      margin: 8px 0 14px;
      line-height: 1.4;
    }

    /* Brand sections */
    .section{
      margin-top: 16px;
      page-break-inside: avoid;
    }

    .sectionHead{
      background: var(--sectionHead);
      color: var(--sectionHeadText);
      padding: 7px 10px;
      border-radius: 6px 6px 0 0;
      display:flex;
      justify-content:space-between;
      align-items:center;
      font-weight: 700;
      font-size: 13px;
      gap: 10px;
    }

    .sectionLeft{
      display:flex;
      align-items:center;
      gap:10px;
      min-width: 0;
    }

    .brandLogo{
      width: 28px;
      height: 28px;
      border-radius: 6px;
      background: rgba(255,255,255,0.08);
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
      flex: 0 0 auto;
      border: 1px solid rgba(255,255,255,0.12);
    }
    .brandLogo img{
      width: 100%;
      height: 100%;
      object-fit: contain;
      padding: 3px;
      display:block;
    }

    .brandBadge{
      width: 28px;
      height: 28px;
      border-radius: 6px;
      background: rgba(255,255,255,0.12);
      color: rgba(255,255,255,0.95);
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight: 800;
      letter-spacing: .02em;
      flex: 0 0 auto;
      border: 1px solid rgba(255,255,255,0.18);
    }

    .brandName{
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 680px;
    }

    .sectionMeta{
      font-size: 11px;
      color:#e5e7eb;
      flex: 0 0 auto;
      white-space:nowrap;
    }

    .tableWrap{
      border: 1px solid var(--tableBorder);
      border-top: none;
      overflow:auto;
    }

    table{
      width:100%;
      border-collapse:collapse;
      font-size: 13px;
      min-width: 820px;
    }
    th, td{
      border: 1px solid var(--tableBorder);
      padding: 6px 8px;
      text-align:left;
      vertical-align: top;
      white-space: nowrap;
    }
    th{
      background: var(--thead);
      font-size: 12px;
      font-weight: 700;
      position: sticky;
      top: 0;
      z-index: 2;
    }
    tbody tr:nth-child(even){
      background: var(--rowAlt);
    }
    td.wrap{white-space: normal}

    .summary{
      margin-top: 12px;
      font-size: 12px;
      color: var(--muted);
    }
    .hidden{display:none !important}

    @media print{
      body{background:#fff;padding:0}
      .paper{box-shadow:none;border:none;padding:10mm;max-width:none}
      .controlsRow,.hint{display:none !important}
      .tableWrap{overflow:visible}
      th{position: static}
      table{min-width: auto}
      td,th{white-space: normal}
    }
  </style>
</head>

<body>
  <div class="paper">

    <div class="topbar">
      <div class="logoSide">
        <img src="assets/images/senturk_logo.png" alt="Şentürk" />
      </div>

      <div class="titleWrap">
        <h1>DİĞER MARKALAR FİYAT LİSTESİ</h1>
        <div class="sub" id="subtitle">Excel Sheet bazlı (her marka ayrı sayfa)</div>
      </div>

      <div class="logoSide right">
        <!-- Optional: if you don't want Marshall here, delete this img -->
        <img src="assets/images/marshall_logo.png" alt="Logo" onerror="this.style.display='none';" />
      </div>
    </div>

    <div class="controlsRow">
      <label>Excel Yükle:</label>
      <input type="file" id="file" accept=".xlsx,.xls" />
      <input class="search" id="search" type="text" placeholder="Ürün / ambalaj / fiyat ara..." />
      <button class="btn btn-light" id="clear">Temizle</button>
      <button class="btn btn-dark" id="printA4">A4 / Standart Yazdır</button>
      <button class="btn btn-dark" id="printPhone">Telefon için Yazdır</button>
    </div>

    <div class="hint">
      • Her sheet = 1 marka bölümü. Her sheet’in ilk dolu satırı başlık kabul edilir ve tabloda aynen görünür.<br>
      • Birleştirilmiş hücrelerden kaynaklı boş “Ürün/Kod” alanları otomatik olarak üst satırdan devralınır.<br>
      • Logo dosyaları: <code>assets/images/dayson_logo.png</code>, <code>assets/images/aquacool_trend_logo.png</code> gibi.
    </div>

    <div id="container"></div>
    <div class="summary" id="summary"></div>
  </div>

<script>
  const elFile = document.getElementById("file");
  const elSearch = document.getElementById("search");
  const elClear = document.getElementById("clear");
  const elPrintA4 = document.getElementById("printA4");
  const elPrintPhone = document.getElementById("printPhone");
  const container = document.getElementById("container");
  const summary = document.getElementById("summary");

  let allRows = [];
  let allSections = [];

  elFile.addEventListener("change", onFile);
  elSearch.addEventListener("input", applySearch);
  elClear.addEventListener("click", () => { elSearch.value=""; applySearch(); });

  elPrintA4.addEventListener("click", () => {
    document.body.classList.remove("phonePrint");
    window.print();
  });

  elPrintPhone.addEventListener("click", () => {
    document.body.classList.add("phonePrint");
    window.print();
    document.body.classList.remove("phonePrint");
  });

  // Phone print tweaks
  const phoneStyle = document.createElement("style");
  phoneStyle.textContent = `
    body.phonePrint .paper{ padding: 6mm !important; }
    body.phonePrint table{ font-size: 15px !important; }
    body.phonePrint th{ font-size: 13px !important; }
    body.phonePrint td, body.phonePrint th{ white-space: normal !important; }
  `;
  document.head.appendChild(phoneStyle);

  function isEmptyRow(row){
    return row.every(c => String(c ?? "").trim() === "");
  }

  function normalize(s){
    return String(s ?? "")
      .trim()
      .toLowerCase()
      .replace(/ı/g,"i").replace(/İ/g,"i")
      .replace(/ğ/g,"g").replace(/Ğ/g,"g")
      .replace(/ü/g,"u").replace(/Ü/g,"u")
      .replace(/ş/g,"s").replace(/Ş/g,"s")
      .replace(/ö/g,"o").replace(/Ö/g,"o")
      .replace(/ç/g,"c").replace(/Ç/g,"c")
      .replace(/[^a-z0-9]+/g,"_")
      .replace(/^_+|_+$/g,"");
  }

  function formatCell(v){
    if (typeof v === "number") {
      const rounded = Math.round((v + Number.EPSILON) * 100) / 100;
      return rounded.toLocaleString("tr-TR", {
        minimumFractionDigits: Number.isInteger(rounded) ? 0 : 2,
        maximumFractionDigits: 2
      }).replace(/,00$/,"");
    }
    const s = String(v ?? "").trim();
    if (s && /^-?\d+(\.\d+)?$/.test(s) && s.length > 10) {
      const num = Number(s);
      if (!Number.isNaN(num)) return formatCell(num);
    }
    return s;
  }

  function guessCarryColumns(headers){
    const idxs = [];
    headers.forEach((h, i) => {
      const n = String(h || "").toLowerCase();
      if (n.includes("kod") || (n.includes("ürün") || n.includes("urun")) || n.includes("renk") || n.includes("baz")) idxs.push(i);
    });
    if (idxs.length === 0 && headers.length) idxs.push(0);
    return Array.from(new Set(idxs));
  }

  function forwardFill(rows, carryIdxs){
    const last = {};
    const out = [];
    for (const r of rows) {
      const row = r.slice();
      const hasAny = row.some(c => String(c ?? "").trim() !== "");
      if (!hasAny) continue;

      for (const idx of carryIdxs) {
        const cur = String(row[idx] ?? "").trim();
        if (!cur && last[idx] !== undefined) row[idx] = last[idx];
        else if (cur) last[idx] = row[idx];
      }
      out.push(row);
    }
    return out;
  }

  function makeBrandLogoNode(sheetName){
    // Expected naming: assets/images/<normalized_sheet>_logo.png
    // e.g. "Aquacool Trend" -> aquacool_trend_logo.png
    const file = `assets/images/${normalize(sheetName)}_logo.png`;

    const holder = document.createElement("div");
    holder.className = "brandLogo";

    const img = document.createElement("img");
    img.alt = sheetName + " logo";
    img.src = file;

    // If not found, replace with a badge
    img.onerror = () => {
      holder.replaceWith(makeBrandBadge(sheetName));
    };

    holder.appendChild(img);
    return holder;
  }

  function makeBrandBadge(sheetName){
    const b = document.createElement("div");
    b.className = "brandBadge";
    const clean = String(sheetName || "").trim();
    b.textContent = clean ? clean[0].toUpperCase() : "?";
    return b;
  }

  function onFile(e){
    const file = e.target.files?.[0];
    if (!file) return;

    container.innerHTML = "";
    summary.textContent = "";
    allRows = [];
    allSections = [];

    const reader = new FileReader();
    reader.onload = ev => {
      const data = new Uint8Array(ev.target.result);
      const wb = XLSX.read(data, { type: "array" });

      let totalVisible = 0;
      let sheetsUsed = 0;

      (wb.SheetNames || []).forEach(sheetName => {
        const ws = wb.Sheets[sheetName];
        const grid = XLSX.utils.sheet_to_json(ws, { header: 1, raw: true, defval: "" });

        // header: first non-empty row with at least 2 cells
        let hIdx = -1;
        for (let i=0;i<grid.length;i++){
          if (!isEmptyRow(grid[i]) && grid[i].filter(c => String(c??"").trim()!=="").length >= 2) { hIdx=i; break; }
        }
        if (hIdx === -1) return;

        const headers = grid[hIdx].map(h => String(h ?? "").trim());
        const dataRowsRaw = grid.slice(hIdx+1).filter(r => !isEmptyRow(r));
        if (dataRowsRaw.length === 0) return;

        const carryIdxs = guessCarryColumns(headers);
        const dataRows = forwardFill(dataRowsRaw, carryIdxs);
        if (dataRows.length === 0) return;

        sheetsUsed++;

        const section = document.createElement("section");
        section.className = "section";

        const head = document.createElement("div");
        head.className = "sectionHead";

        const left = document.createElement("div");
        left.className = "sectionLeft";

        // brand logo (auto)
        left.appendChild(makeBrandLogoNode(sheetName));

        const name = document.createElement("div");
        name.className = "brandName";
        name.textContent = sheetName;
        left.appendChild(name);

        const meta = document.createElement("div");
        meta.className = "sectionMeta";
        meta.textContent = `${dataRows.length} satır`;

        head.appendChild(left);
        head.appendChild(meta);

        section.appendChild(head);

        const wrap = document.createElement("div");
        wrap.className = "tableWrap";

        const table = document.createElement("table");

        const thead = document.createElement("thead");
        const trh = document.createElement("tr");
        headers.forEach(h => {
          const th = document.createElement("th");
          th.textContent = h || "";
          trh.appendChild(th);
        });
        thead.appendChild(trh);
        table.appendChild(thead);

        const tbody = document.createElement("tbody");

        dataRows.forEach(r => {
          const row = r.slice(0, headers.length);
          while (row.length < headers.length) row.push("");

          const hasAny = row.some(c => String(c ?? "").trim() !== "");
          if (!hasAny) return;

          const tr = document.createElement("tr");
          tr.dataset.search = (sheetName + " | " + row.map(formatCell).join(" | ")).toLowerCase();

          row.forEach((cell, idx) => {
            const td = document.createElement("td");
            const hn = String(headers[idx] || "").toLowerCase();
            if (hn.includes("ürün") || hn.includes("urun") || hn.includes("açıklama") || hn.includes("aciklama")) td.classList.add("wrap");
            td.textContent = formatCell(cell);
            tr.appendChild(td);
          });

          tbody.appendChild(tr);
          allRows.push(tr);
        });

        table.appendChild(tbody);
        wrap.appendChild(table);
        section.appendChild(wrap);
        container.appendChild(section);
        allSections.push(section);

        totalVisible += dataRows.length;
      });

      summary.textContent = `${sheetsUsed} marka (sheet) yüklendi. Toplam satır: ${totalVisible}.`;
      applySearch();
    };

    reader.readAsArrayBuffer(file);
  }

  function applySearch(){
    const q = elSearch.value.trim().toLowerCase();
    if (!q) {
      allRows.forEach(tr => tr.classList.remove("hidden"));
      allSections.forEach(sec => sec.classList.remove("hidden"));
      return;
    }

    const visibleSec = new Set();

    allRows.forEach(tr => {
      const ok = tr.dataset.search.includes(q);
      tr.classList.toggle("hidden", !ok);
      if (ok) {
        const sec = tr.closest(".section");
        if (sec) visibleSec.add(sec);
      }
    });

    allSections.forEach(sec => sec.classList.toggle("hidden", !visibleSec.has(sec)));
  }
</script>
</body>
</html>
