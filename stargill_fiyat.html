<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>STARGIL Fiyat Listesi</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    :root{
      --senturk-navy:#1b2533;
      --border-light:#dcdcdc;
      --bg-light:#f7f7f7;
      --footer-bordo:#7b1f22;
    }

    body{
      margin:0;
      padding:24px;
      background:#e6e6e6;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI","Helvetica Neue",Arial,"Noto Sans",sans-serif;
    }

    .page{
      max-width:1100px;
      margin:auto;
      background:#fff;
      padding:24px 32px 32px;
      box-shadow:0 0 12px rgba(0,0,0,0.12);
    }

    /* HEADER */
    .header{
      display:flex;
      justify-content:space-between;
      align-items:flex-end;
      margin-bottom:12px;
    }
    .senturk-logo img{ height:50px; width:auto; }
    .brand-logo img{ height:50px; width:auto; }

    /* SUBHEADER */
    .subheader{
      margin-top:6px;
      padding-top:8px;
      margin-bottom:10px;
      border-top:1px solid #000;
      font-weight:700;
      text-align:center;
      color:var(--senturk-navy);
    }
    .editable-title{
      display:inline-block;
      padding:0 4px;
      min-width:80px;
      border-bottom:1px dashed #ccc;
      cursor:text;
    }
    .editable-title:focus{ outline:2px solid #ffd27f; }

    /* TOOLBAR */
    .toolbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:12px;
      gap:8px;
      flex-wrap:wrap;
      font-size:13px;
    }
    .toolbar-left,.toolbar-right{
      display:flex;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
    }
    input[type="file"]{
      padding:4px 6px;
      border:1px solid #ccc;
      border-radius:4px;
      font-size:12px;
    }
    #searchInput{
      padding:4px 8px;
      border-radius:4px;
      border:1px solid #ccc;
      font-size:12px;
      min-width:220px;
    }
    #searchInput::placeholder{ color:#999; }

    .toolbar button{
      padding:6px 10px;
      border-radius:4px;
      border:none;
      background:var(--senturk-navy);
      color:#fff;
      font-size:12px;
      cursor:pointer;
    }
    .toolbar button:hover{ opacity:0.9; }

    /* CONTENT – 2 columns on big screens */
    #content{
      column-count:2;
      column-gap:16px;
    }
    @media (max-width:1200px){
      #content{ column-count:1; }
    }
    .group-block{
      break-inside:avoid;
      page-break-inside:avoid;
      margin-bottom:14px;
    }

    /* TABLE */
    table.section-matrix{
      width:100%;
      border-collapse:collapse;
      table-layout:fixed;
      font-size:11px;
      background:#fff;
    }
    table.section-matrix th,
    table.section-matrix td{
      border:1px solid var(--border-light);
      padding:6px 6px;
      text-align:center;
      vertical-align:middle;
      line-height:1.2;
    }
    table.section-matrix th{
      background:var(--bg-light);
      font-weight:900;
      font-size:10px;
      white-space:normal;
      word-break:break-word;
    }

    /* Section name: WHITE */
    td.section-name{
      font-weight:900;
      background:#fff;
      white-space:normal;
      word-break:break-word;
      overflow-wrap:anywhere;
      line-height:1.25;
      padding:10px 8px;
    }

    td.sec-desc{
      white-space:normal;
      word-break:break-word;
      overflow-wrap:anywhere;
      line-height:1.25;
    }

    /* Numeric cells never wrap (prevents split digits) */
    td.nowrap{
      white-space:nowrap !important;
      word-break:normal !important;
      overflow-wrap:normal !important;
      font-variant-numeric:tabular-nums;
    }
    td.sec-price{ font-weight:900; }

    table.section-matrix tbody tr:nth-child(even){ background:#f7f7f7; }

    /* Header label swapping (long on screen, short on print) */
    .h-short{ display:none; }

    /* FOOTER */
    .footer{
      margin-top:18px;
      padding-top:8px;
      border-top:4px solid var(--footer-bordo);
      font-size:11px;
      color:var(--footer-bordo);
      text-align:center;
      line-height:1.4;
    }
    .footer .line{ margin:2px 0; }

    /* ==========================================================
       PRINT FIXES (THIS IS THE IMPORTANT PART)
       ========================================================== */
    @media print{
      body{ background:#fff; margin:0; padding:0; }
      .page{
        box-shadow:none !important;
        margin:0;
        max-width:100%;
        padding:10mm 8mm 10mm;
      }
      .toolbar{ display:none !important; }

      /* ✅ Default print: 1 column so tables are readable */
      #content{
        column-count:1 !important;
        column-gap:0 !important;
      }

      /* ✅ Use short header labels in print (prevents ugly wrapping) */
      .h-long{ display:none !important; }
      .h-short{ display:inline !important; }

      table.section-matrix{
        font-size:10px !important;
      }
      table.section-matrix th{
        font-size:9px !important;
        padding:2mm 1.5mm !important;
        line-height:1.1 !important;
      }
      table.section-matrix td{
        padding:2mm 1.5mm !important;
        line-height:1.15 !important;
      }

      /* ✅ Stronger borders on paper */
      table.section-matrix, table.section-matrix th, table.section-matrix td{
        border-color:#000 !important;
      }

      /* ✅ Prevent tables splitting weirdly */
      .group-block, table, tr, td, th{ page-break-inside:avoid !important; }

      /* Optional: black & white print mode */
      body.bw-print *{
        color:#000 !important;
        text-shadow:none !important;
        box-shadow:none !important;
      }
      body.bw-print table.section-matrix th{ background:#fff !important; }
      body.bw-print table.section-matrix tbody tr:nth-child(even){ background:#fff !important; }
      body.bw-print .footer{
        color:#000 !important;
        border-top:2px solid #000 !important;
      }

      /* ✅ Landscape mode (A4) */
      @page { margin: 10mm 8mm; }
      body.landscape-print @page { size: A4 landscape; }

      /* ✅ Landscape: allow 2 columns again (because page is wider) */
      body.landscape-print #content{
        column-count:2 !important;
        column-gap:8mm !important;
      }
    }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>

<body>
<div class="page">

  <div class="header">
    <div class="senturk-logo">
      <img src="assets/images/senturk_logo.png" alt="Şentürk" />
    </div>
    <div class="brand-logo">
      <img src="assets/images/stargill_logo.png" alt="StarGil" />
    </div>
  </div>

  <div class="subheader">
    <span id="titleLabel" contenteditable="true" class="editable-title">STARGIL FİYAT LİSTESİ</span>
    &nbsp;–&nbsp;
    <span id="monthLabel" contenteditable="true" class="editable-title"></span>
  </div>

  <div class="toolbar">
    <div class="toolbar-left">
      <label for="excelInput">Excel Yükle:</label>
      <input type="file" id="excelInput" accept=".xlsx,.xls" />
    </div>
    <div class="toolbar-right">
      <input type="text" id="searchInput" placeholder="Ürün / kod / açıklama ara..." />
      <button type="button" id="clearSearchBtn">Temizle</button>

      <button type="button" onclick="printPortrait()">Yazdır (A4 / Dikey)</button>
      <button type="button" onclick="printLandscape()">Yazdır (A4 / Yatay 2 Kolon)</button>
      <button type="button" onclick="printBW()">Siyah Beyaz Yazdır</button>
    </div>
  </div>

  <div id="content"></div>

  <div class="footer">
    <div class="line">
      Şentürk Boya İnş. Tur. San. Tic. Ltd. Şti. &nbsp;&nbsp;
      Adres : Petrol İş Mah. Kızılay Bulvarı Efe Sok. No:4 Toprakyol Kartal / İstanbul
    </div>
    <div class="line">
      Telefon: 0216 - 473 78 90 &nbsp;&nbsp;&nbsp;
      Fax : 0216 - 473 78 93 &nbsp;&nbsp;&nbsp;
      info@senturkboya.com
    </div>
  </div>

</div>

<script>
/* ==========================================================
   CONFIG
   ========================================================== */
const DEFAULT_EXCEL_PATH = "assets/data/Book1.xlsx";

/* ==========================================================
   HELPERS
   ========================================================== */
function isBlank(v){ return v === null || v === undefined || String(v).trim() === ""; }
function isBlankRow(r){ return r.every(isBlank); }
function norm(v){ return (v ?? "").toString().trim().toLocaleLowerCase("tr-TR"); }

function parseNumberFlexible(val){
  if (val == null || val === "") return NaN;
  if (typeof val === "number") return val;
  let s = val.toString().trim();
  if (!s) return NaN;
  s = s.replace(/[^0-9,.\-]/g, "");
  if (s.includes(",")){
    s = s.replace(/\./g, "").replace(",", ".");
    return parseFloat(s);
  }
  const firstDot = s.indexOf(".");
  const lastDot = s.lastIndexOf(".");
  if (firstDot !== -1 && firstDot !== lastDot){
    const intPart = s.slice(0, lastDot).replace(/\./g, "");
    const decPart = s.slice(lastDot + 1);
    s = intPart + "." + decPart;
  }
  return parseFloat(s);
}

function fmtPrice(val){
  const n = (typeof val === "number") ? val : parseNumberFlexible(val);
  if (isNaN(n)) return (val ?? "").toString().trim();
  return n.toLocaleString("tr-TR", { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}

function fmtSmart(val){
  if (val == null) return "";
  if (typeof val === "string" && /[()]/.test(val)) return val.trim();
  const n = (typeof val === "number") ? val : parseNumberFlexible(val);
  if (isNaN(n)) return (val ?? "").toString().trim();
  const isInt = Math.abs(n - Math.round(n)) < 1e-9;
  return n.toLocaleString("tr-TR", { minimumFractionDigits: 0, maximumFractionDigits: isInt ? 0 : 3 });
}

function fmtCode(val){
  if (val == null) return "";
  if (typeof val === "number"){
    const s = String(Math.trunc(val));
    return s.padStart(5, "0");
  }
  const s = val.toString().trim();
  if (/^\d+$/.test(s) && s.length < 5) return s.padStart(5, "0");
  return s;
}

/* ==========================================================
   HEADER DETECTION (NO KUTU/KOLI)
   ========================================================== */
function detectHeaderMap(row){
  const findIdx = (pred) => {
    for (let i=0;i<row.length;i++){
      const t = norm(row[i]);
      if (pred(t)) return i;
    }
    return -1;
  };

  const kodNo = findIdx(t => t === "kod no" || t.includes("kod no"));
  const aciklama = findIdx(t => t === "açıklama" || t === "aciklama" || t.includes("açıklama") || t.includes("aciklama"));
  const ebat = findIdx(t => t === "ebat" || t.includes("ebat"));
  const fiyat = findIdx(t => t.includes("fiyat"));
  const kdvDahil = findIdx(t => t.includes("kdv") && t.includes("dahil"));

  let sectionCol = 0;
  if (kodNo > 0) sectionCol = kodNo - 1;

  const isValid = kodNo !== -1 && aciklama !== -1 && ebat !== -1 && fiyat !== -1 && kdvDahil !== -1;
  return { isValid, sectionCol, kodNo, aciklama, ebat, fiyat, kdvDahil };
}
function isHeaderRow(row){ return detectHeaderMap(row).isValid; }

/* ==========================================================
   RENDER
   ========================================================== */
function renderFromAOA(aoa){
  let html = "";
  let i = 0;

  while (i < aoa.length){
    const row = aoa[i];

    if (isHeaderRow(row)){
      const map = detectHeaderMap(row);
      i++;

      let sectionName = "";
      let lastDesc = "";
      const items = [];

      while (i < aoa.length && !isBlankRow(aoa[i]) && !isHeaderRow(aoa[i])){
        const r = aoa[i];

        const secCell = (map.sectionCol >= 0) ? (r[map.sectionCol] ?? "") : "";
        const maybeSection = (secCell ?? "").toString().trim();
        if (maybeSection) sectionName = maybeSection;

        const code = fmtCode(r[map.kodNo]);
        const desc = (r[map.aciklama] ?? "").toString().trim();
        if (desc) lastDesc = desc;

        const ebatVal = r[map.ebat];
        const fiyatVal = r[map.fiyat];
        const kdvVal = r[map.kdvDahil];

        if (!isBlank(code)){
          items.push({
            sectionName: sectionName || "Bölüm",
            code,
            desc: lastDesc || "",
            ebat: fmtSmart(ebatVal),
            fiyat: isBlank(fiyatVal) ? "" : fmtPrice(fiyatVal),
            kdv: isBlank(kdvVal) ? "" : fmtPrice(kdvVal)
          });
        }
        i++;
      }

      if (items.length){
        const secName = items[0].sectionName;

        html += `<div class="group-block">`;
        html += `
          <table class="section-matrix">
            <colgroup>
              <col style="width:24%">
              <col style="width:12%">
              <col style="width:38%">
              <col style="width:10%">
              <col style="width:8%">
              <col style="width:8%">
            </colgroup>
            <thead>
              <tr>
                <th></th>
                <th>Kod No</th>
                <th>Açıklama</th>
                <th>Ebat</th>
                <th>
                  <span class="h-long">Fiyat (KDV Hariç)</span>
                  <span class="h-short">Fiyat</span>
                </th>
                <th>
                  <span class="h-long">KDV Dahil</span>
                  <span class="h-short">KDV</span>
                </th>
              </tr>
            </thead>
            <tbody>
        `;

        items.forEach((it, idx) => {
          html += `<tr>`;
          if (idx === 0){
            html += `<td class="section-name" rowspan="${items.length}">${secName}</td>`;
          }
          html += `
            <td class="nowrap">${it.code}</td>
            <td class="sec-desc">${it.desc}</td>
            <td class="nowrap">${it.ebat}</td>
            <td class="nowrap sec-price">${it.fiyat}</td>
            <td class="nowrap sec-price">${it.kdv}</td>
          `;
          html += `</tr>`;
        });

        html += `</tbody></table></div>`;
      }

      while (i < aoa.length && isBlankRow(aoa[i])) i++;
      continue;
    }

    i++;
  }

  document.getElementById("content").innerHTML =
    html || `<div style="color:#666;font-size:13px;">Excel verisi bulunamadı.</div>`;

  applySearch();
}

/* ==========================================================
   SEARCH
   ========================================================== */
function applySearch(){
  const term = document.getElementById("searchInput").value.trim().toLowerCase();
  const blocks = document.querySelectorAll("#content .group-block");
  if (!term){
    blocks.forEach(b => b.style.display = "");
    return;
  }
  blocks.forEach(b => {
    const text = b.textContent.toLowerCase();
    b.style.display = text.includes(term) ? "" : "none";
  });
}

/* ==========================================================
   PRINT
   ========================================================== */
function clearPrintClasses(){
  document.body.classList.remove("bw-print","landscape-print");
}
function printPortrait(){
  clearPrintClasses();
  window.print();
}
function printLandscape(){
  clearPrintClasses();
  document.body.classList.add("landscape-print");
  window.print();
}
function printBW(){
  clearPrintClasses();
  document.body.classList.add("bw-print");
  window.print();
}
window.addEventListener("afterprint", clearPrintClasses);

/* ==========================================================
   EXCEL LOAD
   ========================================================== */
function renderWorksheet(ws){
  const aoa = XLSX.utils.sheet_to_json(ws, { header: 1, defval: "" });
  const hasHeader = aoa.some(r => isHeaderRow(r));
  if (!hasHeader){
    document.getElementById("content").innerHTML =
      `<div style="color:#b00;font-size:13px;">
        Bu sayfa “Kod No / Açıklama / Ebat / Fiyat / KDV Dahil” başlıklı tablo formatını bekliyor.
      </div>`;
    return;
  }
  renderFromAOA(aoa);
}

document.getElementById("excelInput").addEventListener("change", e => {
  const file = e.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = evt => {
    const workbook = XLSX.read(evt.target.result, { type: "array" });
    let sheetName = "Sheet1";
    if (!workbook.Sheets[sheetName]) sheetName = workbook.SheetNames[0];
    renderWorksheet(workbook.Sheets[sheetName]);
  };
  reader.readAsArrayBuffer(file);
});

function autoLoadExcel(){
  fetch(DEFAULT_EXCEL_PATH)
    .then(r => r.arrayBuffer())
    .then(buf => {
      const workbook = XLSX.read(buf, { type: "array" });
      let sheetName = "Sheet1";
      if (!workbook.Sheets[sheetName]) sheetName = workbook.SheetNames[0];
      renderWorksheet(workbook.Sheets[sheetName]);
    })
    .catch(err => console.error("Auto-load Excel failed:", err));
}

/* INIT */
document.addEventListener("DOMContentLoaded", () => {
  const now = new Date();
  const months = ["OCAK","ŞUBAT","MART","NİSAN","MAYIS","HAZİRAN","TEMMUZ","AĞUSTOS","EYLÜL","EKİM","KASIM","ARALIK"];
  const monthLabel = document.getElementById("monthLabel");
  if (monthLabel) monthLabel.textContent = `${months[now.getMonth()]} ${now.getFullYear()}`;

  const searchInput = document.getElementById("searchInput");
  const clearBtn = document.getElementById("clearSearchBtn");
  if (searchInput) searchInput.addEventListener("input", applySearch);
  if (clearBtn){
    clearBtn.addEventListener("click", () => {
      searchInput.value = "";
      applySearch();
    });
  }

  autoLoadExcel();
});
</script>
</body>
</html>
